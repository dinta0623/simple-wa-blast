"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports["default"]=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _http=require("http");var _socket=require("socket.io");var _whatsappWeb=require("whatsapp-web.js");var _express=_interopRequireDefault(require("express"));var _app=_interopRequireDefault(require("./app"));var _qrcode=require("qrcode");var _db=require("./utils/db");var _persist=_interopRequireDefault(require("./utils/persist"));var _events=_interopRequireDefault(require("events"));function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=(0,_getPrototypeOf2["default"])(Derived),result;if(hasNativeReflectConstruct){var NewTarget=(0,_getPrototypeOf2["default"])(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return(0,_possibleConstructorReturn2["default"])(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}var Server=function(_EventEmitter){(0,_inherits2["default"])(Server,_EventEmitter);var _super=_createSuper(Server);function Server(session){var _this;(0,_classCallCheck2["default"])(this,Server);_this=_super.call(this);(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(_this),"server",void 0);(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(_this),"socket",void 0);(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(_this),"app",void 0);(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(_this),"client",void 0);(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(_this),"presist",void 0);(0,_defineProperty2["default"])((0,_assertThisInitialized2["default"])(_this),"io",void 0);_this.presist=new _persist["default"]();_this.app=(0,_express["default"])();_this.server=(0,_http.createServer)(_this.app);_this.socket=new _socket.Server(_this.server);_this.client=new _whatsappWeb.Client({restartOnAuthFail:true,puppeteer:{headless:true,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-first-run","--no-zygote","--single-process","--disable-gpu"]},session:session});_this.preload();_this.presist.set("auth",true);return _this;}(0,_createClass2["default"])(Server,[{key:"preload",value:function preload(){var _this2=this;new _app["default"](this,this.app,this.client,this.presist);this.socket.on("connection",function(io){_this2.io=io;});}},{key:"load",value:function load(){var _this3=this;this.client.on("qr",function(qr){try{(0,_qrcode.toDataURL)(qr,function(err,url){if(!_this3.presist.get("auth")){_this3.io&&_this3.io.emit("qrcode",url);}});}catch(err){(0,_db.saveError)("client","qrcode",err);}});this.client.on("authenticated",function(){var _ref=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(session){return _regenerator["default"].wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:console.log("Siap Digunakan");_context.next=3;return(0,_db.setSession)(session.WABrowserId,session.WASecretBundle,session.WAToken1,session.WAToken2);case 3:(0,_db.setLogCustom)("Autentikasi berhasil");_this3.presist.set("auth",true);_this3.io&&_this3.io.emit("succeed");case 6:case"end":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}());this.client.on("auth_failure",function(err){_this3.presist.set("auth",false);(0,_db.setLogCustom)("Autentikasi gagal!, scan qr-code atau tunggu hingga server siap digunakan");(0,_db.saveError)("client","autentikasi",new Error(err));console.log("Autentikasi gagal : "+err);_this3.io&&_this3.io.emit("failed");});this.client.on("disconnected",function(reason){(0,_db.saveError)("client","autentikasi",new Error("user has disconnected | reason: ".concat(reason)));(0,_db.setLogCustom)("User disconnect, scan qr-code jika muncul. Sebaliknya tunggu hingga server berhasil take over wa-web (multi session wa-web konflik)");console.log("dc : "+reason);_this3.io&&_this3.io.emit("failed");_this3.client.destroy();_this3.client.initialize();});}},{key:"init",value:function init(){this.load();this.client.initialize();this.server.listen(process.env.PORT||8090,function(){console.log("Server is running!");});}}]);return Server;}(_events["default"]);exports["default"]=Server;function run(){return _run.apply(this,arguments);}function _run(){_run=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee2(){var _yield$getSession,WABrowserId,WASecretBundle,WAToken1,WAToken2;return _regenerator["default"].wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return(0,_db.getSession)();case 2:_yield$getSession=_context2.sent;WABrowserId=_yield$getSession.waBrowserId;WASecretBundle=_yield$getSession.waSecretBundle;WAToken1=_yield$getSession.waToken1;WAToken2=_yield$getSession.waToken2;new Server({WABrowserId:WABrowserId,WASecretBundle:WASecretBundle,WAToken1:WAToken1,WAToken2:WAToken2}).init();case 8:case"end":return _context2.stop();}}},_callee2);}));return _run.apply(this,arguments);}run();